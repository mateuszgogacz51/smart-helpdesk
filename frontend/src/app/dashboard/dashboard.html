<div class="dashboard-container">
  
  <header class="top-bar">
    <div class="welcome-section">
      <h2>Smart Helpdesk</h2>
    </div>
    <div class="user-info">
      <span>Witaj, <strong>{{ currentUser }}</strong> ({{ currentUserRole }})</span>
      <button class="logout-btn" (click)="logout()">Wyloguj</button>
    </div>
  </header>

  <div class="content-area">

    <div class="stats-container" *ngIf="stats && currentUserRole !== 'USER'">
      
      <div class="stats-group">
        <h3>Moje Zadania</h3>
        <div class="cards-row">
          <div class="stat-card blue clickable" 
               [class.active-filter]="activeFilter === 'OPEN' && viewMode === 'MY'"
               (click)="viewMode = 'MY'; setFilter('OPEN')">
            <span class="count">{{ stats.myOpen }}</span>
            <span class="label">Nowe</span>
          </div>
          <div class="stat-card orange clickable" 
               [class.active-filter]="activeFilter === 'IN_PROGRESS' && viewMode === 'MY'"
               (click)="viewMode = 'MY'; setFilter('IN_PROGRESS')">
            <span class="count">{{ stats.myInProgress }}</span>
            <span class="label">W trakcie</span>
          </div>
          <div class="stat-card green clickable" 
               [class.active-filter]="activeFilter === 'CLOSED' && viewMode === 'MY'"
               (click)="viewMode = 'MY'; setFilter('CLOSED')">
            <span class="count">{{ stats.myClosed }}</span>
            <span class="label">Gotowe</span>
          </div>
        </div>
      </div>

      <div class="stats-group">
        <h3>Cała Firma</h3>
        <div class="cards-row">
          <div class="stat-card purple clickable" 
               [class.active-filter]="activeFilter === 'UNASSIGNED' && viewMode === 'ALL'"
               (click)="viewMode = 'ALL'; setFilter('UNASSIGNED')">
            <span class="count">{{ stats.globalUnassigned }}</span>
            <span class="label">Do wzięcia</span>
          </div>
          
          <div class="stat-card dark clickable"
               [class.active-filter]="activeFilter === 'ALL' && viewMode === 'ALL'"
               (click)="viewMode = 'ALL'; setFilter('ALL')">
            <span class="count">{{ stats.globalTotal }}</span>
            <span class="label">Wszystkie</span>
          </div>
        </div>
      </div>
    </div>

    <div class="action-bar">
      <div class="view-toggle" *ngIf="currentUserRole !== 'USER'">
        <button [class.active]="viewMode === 'ALL'" (click)="viewMode = 'ALL'; setFilter('ALL')">Wszystkie</button>
        <button [class.active]="viewMode === 'MY'" (click)="viewMode = 'MY'; setFilter('ALL')">Tylko moje</button>
      </div>
      
      <div *ngIf="currentUserRole === 'USER'" style="font-weight:bold; color:#2c3e50;">
        Twoje zgłoszenia
      </div>

      <button class="add-btn" (click)="goToAddTicket()">+ Nowe zgłoszenie</button>
    </div>

    <div class="table-wrapper">
      <table class="tickets-table">
        <thead>
          <tr>
            <th (click)="sortTable('id')">ID {{ getSortIcon('id') }}</th>
            <th (click)="sortTable('title')">Tytuł {{ getSortIcon('title') }}</th>
            <th (click)="sortTable('status')">Status {{ getSortIcon('status') }}</th>
            <th (click)="sortTable('category')">Kategoria {{ getSortIcon('category') }}</th>
            <th (click)="sortTable('author.username')">Autor {{ getSortIcon('author.username') }}</th>
            <th (click)="sortTable('assignedUser.username')">Przypisany {{ getSortIcon('assignedUser.username') }}</th>
            <th (click)="sortTable('createdDate')">Data {{ getSortIcon('createdDate') }}</th>
            <th>Akcja</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let ticket of visibleTickets">
            <td>#{{ ticket.id }}</td>
            <td><strong>{{ ticket.title }}</strong></td>
            <td><span class="status-badge" [ngClass]="ticket.status">{{ ticket.status }}</span></td>
            <td>{{ ticket.category }}</td>
            <td>{{ ticket.author?.username }}</td>
            <td>
              <span *ngIf="ticket.assignedUser" class="assignee-badge">{{ ticket.assignedUser?.username }}</span>
              <span *ngIf="!ticket.assignedUser" style="color:#bdc3c7; font-style: italic;">Brak</span>
            </td>
            <td>{{ ticket.createdDate | date:'short' }}</td>
            <td>
              <button class="details-btn" (click)="goToDetails(ticket.id!)">Podgląd</button>
            </td>
          </tr>
          <tr *ngIf="visibleTickets.length === 0">
            <td colspan="8" style="text-align:center; padding: 40px; color:#95a5a6;">
              Brak zgłoszeń w tym widoku.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>