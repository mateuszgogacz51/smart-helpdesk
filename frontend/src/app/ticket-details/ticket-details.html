<div class="dashboard-container" *ngIf="ticket; else loadingTemplate">
  
  <header class="details-header">
    <button class="back-btn" (click)="goBack()">‚Üê Wr√≥ƒá do listy</button>
  </header>

  <div class="content-grid">
    
    <main class="main-column">
      
      <section class="card-panel ticket-card">
        <div class="card-header-row">
          <h1 class="ticket-title">#{{ ticket.id }} {{ ticket.title }}</h1>
          <span class="date-badge">{{ ticket.createdDate | date:'medium' }}</span>
        </div>
        <div class="description-box">
          <p>{{ ticket.description }}</p>
        </div>
      </section>

      <section class="card-panel history-section">
        <h3 class="panel-title">üìú Dziennik Zdarze≈Ñ</h3>
        
        <table class="history-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Kto</th>
              <th>Akcja</th>
              <th>Zmiana</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of history">
              <td>{{ entry.timestamp | date:'short' }}</td>
              <td><strong>{{ entry.modifier?.username }}</strong></td>
              <td>
                <span *ngIf="entry.changeType === 'STATUS_CHANGE'">Status</span>
                <span *ngIf="entry.changeType === 'PRIORITY_CHANGE'">Priorytet</span>
                <span *ngIf="entry.changeType === 'ASSIGNMENT_CHANGE'">Przypisanie</span>
              </td>
              <td>
                <span style="color: #999; text-decoration: line-through;">{{ entry.oldValue }}</span> 
                ‚ûù 
                <span style="color: #2c3e50; font-weight: bold;">{{ entry.newValue }}</span>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="history.length === 0" style="text-align: center; padding: 15px; color: #aaa;">Brak historii zmian.</div>
      </section>

      <section class="card-panel comments-section">
        <h3 class="panel-title">üí¨ Komentarze ({{ comments.length }})</h3>
        
        <div class="comments-list">
          <div class="comment-item" *ngFor="let comment of comments">
            <div class="comment-meta">
              <strong>{{ comment.author?.username }}</strong>
              <span class="comment-date">{{ comment.createdDate | date:'short' }}</span>
            </div>
            <div class="comment-body">{{ comment.content }}</div>
          </div>
          <div *ngIf="comments.length === 0" class="empty-state" style="padding: 20px; text-align: center; color: #999;">
            Brak komentarzy. Rozpocznij dyskusjƒô!
          </div>
        </div>

        <div class="add-comment-area">
          <textarea [(ngModel)]="newCommentContent" placeholder="Napisz notatkƒô lub odpowied≈∫..." rows="3" class="styled-input"></textarea>
          <button class="save-btn" (click)="addComment()">Wy≈õlij komentarz</button>
        </div>
      </section>

    </main>

    <aside class="sidebar-column">
      
      <div class="card-panel info-card">
        <h3 class="panel-title">Informacje</h3>

        <div class="info-group">
          <label>Status</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyStatus">
             <select [ngModel]="ticket.status" (change)="changeStatus($event)" class="styled-select">
                <option value="OPEN">Nowe</option>
                <option value="IN_PROGRESS">W trakcie</option>
                <option value="CLOSED">Zamkniƒôte</option>
             </select>
          </div>
          <ng-template #readOnlyStatus>
             <span class="status-badge" [ngClass]="ticket.status">{{ ticket.status }}</span>
          </ng-template>
        </div>

        <div class="info-group">
          <label>Priorytet</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyPriority">
            <select [ngModel]="ticket.priority" (change)="updatePriority($event)" class="styled-select">
              <option value="LOW">Niski</option>
              <option value="NORMAL">Normalny</option>
              <option value="HIGH">üî• PILNE</option>
            </select>
          </div>
          <ng-template #readOnlyPriority>
            <span class="value-text">{{ ticket.priority }}</span>
          </ng-template>
        </div>

        <div class="info-group">
          <label>Kategoria</label>
          <div class="value-text">{{ ticket.category }}</div>
        </div>

        <div class="info-group">
          <label>Zg≈ÇaszajƒÖcy</label>
          <div class="value-text user-value">üë§ {{ ticket.author?.username }}</div>
        </div>

        <div class="info-group">
          <label>Przypisano do</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyAssignee">
             <select [ngModel]="ticket.assignedUser?.id" (change)="assignTicket($event)" class="styled-select">
               <option [ngValue]="null">-- Brak --</option>
               <option *ngFor="let staff of supportStaff" [value]="staff.id">
                 {{ staff.username }}
               </option>
             </select>
             <button class="action-btn-small" (click)="assignToMe()">Przypisz mnie</button>
          </div>
          <ng-template #readOnlyAssignee>
            <span class="value-text" style="color: #2980b9;">{{ ticket.assignedUser?.username || 'Brak' }}</span>
          </ng-template>
        </div>
      </div>

    </aside>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-state" style="text-align: center; padding: 50px; color: #666;">
    <h2>‚è≥ ≈Åadowanie zg≈Çoszenia...</h2>
  </div>
</ng-template>