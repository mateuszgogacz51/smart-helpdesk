<div class="dashboard-container" *ngIf="ticket; else loadingTemplate">
  
  <header class="details-header">
    <button class="back-btn" (click)="goBack()">â† WrÃ³Ä‡ do listy</button>
  </header>

  <div class="content-grid">
    
    <main class="main-column">
      
      <section class="card-panel ticket-card">
        <div class="card-header-row">
          <h1 class="ticket-title">#{{ ticket.id }} {{ ticket.title }}</h1>
          <span class="date-badge">{{ ticket.createdDate | date:'medium' }}</span>
        </div>
        <div class="description-box">
          <p>{{ ticket.description }}</p>
        </div>
      </section>

      <section class="card-panel attachments-section">
        <h3 class="panel-title">ğŸ“ ZaÅ‚Ä…czniki ({{ attachments.length }})</h3>

        <div class="attachments-list" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
          <div *ngFor="let file of attachments" style="background: #f8f9fa; padding: 10px 15px; border-radius: 6px; border: 1px solid #e9ecef; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2rem;">ğŸ“„</span>
            <div style="display: flex; flex-direction: column;">
              <span style="font-weight: 600; font-size: 0.9rem; color: #333;">{{ file.filename }}</span>
              <a [href]="ticketService.getDownloadUrl(file.id)" target="_blank" style="font-size: 0.8rem; color: #3498db; text-decoration: none; margin-top: 2px;">Pobierz</a>
            </div>
          </div>
          <div *ngIf="attachments.length === 0" style="color: #999; font-style: italic; font-size: 0.9rem; padding: 5px;">
             Brak zaÅ‚Ä…cznikÃ³w.
          </div>
        </div>

        <div class="upload-area" style="border-top: 1px solid #f0f0f0; padding-top: 15px;">
          <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none;">
          
          <button (click)="fileInput.click()" 
                  [disabled]="isUploading" 
                  class="save-btn" 
                  style="width: auto; margin-top: 0; padding: 10px 20px; background: #3498db;">
            {{ isUploading ? 'â³ WysyÅ‚anie...' : 'ğŸ“ Dodaj plik' }}
          </button>
        </div>
      </section>

      <section class="card-panel history-section">
        <h3 class="panel-title">ğŸ“œ Dziennik ZdarzeÅ„</h3>
        
        <table class="history-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Kto</th>
              <th>Akcja</th>
              <th>Zmiana</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of history">
              <td>{{ entry.timestamp | date:'short' }}</td>
              <td><strong>{{ entry.modifier?.username }}</strong></td>
              <td>
                <span *ngIf="entry.changeType === 'STATUS_CHANGE'">Status</span>
                <span *ngIf="entry.changeType === 'PRIORITY_CHANGE'">Priorytet</span>
                <span *ngIf="entry.changeType === 'ASSIGNMENT_CHANGE'">Przypisanie</span>
                <span *ngIf="entry.changeType === 'CATEGORY_CHANGE'">Kategoria</span>
              </td>
              <td>
                <span style="color: #999; text-decoration: line-through;">{{ entry.oldValue }}</span> 
                â 
                <span style="color: #2c3e50; font-weight: bold;">{{ entry.newValue }}</span>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="history.length === 0" style="text-align: center; padding: 15px; color: #aaa;">Brak historii zmian.</div>
      </section>

      <section class="card-panel comments-section">
        <h3 class="panel-title">ğŸ’¬ Komentarze ({{ comments.length }})</h3>
        
        <div class="comments-list">
          <div class="comment-item" *ngFor="let comment of comments">
            <div class="comment-meta">
              <strong>{{ comment.author?.username }}</strong>
              <span class="comment-date">{{ comment.createdDate | date:'short' }}</span>
            </div>
            <div class="comment-body">{{ comment.content }}</div>
          </div>
          <div *ngIf="comments.length === 0" class="empty-state" style="padding: 20px; text-align: center; color: #999;">
            Brak komentarzy. Rozpocznij dyskusjÄ™!
          </div>
        </div>

        <div class="add-comment-area">
          <textarea [(ngModel)]="newCommentContent" placeholder="Napisz notatkÄ™ lub odpowiedÅº..." rows="3" class="styled-input"></textarea>
          <button class="save-btn" (click)="addComment()">WyÅ›lij komentarz</button>
        </div>
      </section>

    </main>

    <aside class="sidebar-column">
      
      <div class="card-panel info-card">
        <h3 class="panel-title">Informacje</h3>

        <div class="info-group">
          <label>Status</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyStatus">
             <select [ngModel]="ticket.status" (change)="changeStatus($event)" class="styled-select">
                <option value="OPEN">Nowe</option>
                <option value="IN_PROGRESS">W trakcie</option>
                <option value="CLOSED">ZamkniÄ™te</option>
             </select>
          </div>
          <ng-template #readOnlyStatus>
             <span class="status-badge" [ngClass]="ticket.status">{{ ticket.status }}</span>
          </ng-template>
        </div>

        <div class="info-group">
          <label>Priorytet</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyPriority">
            <select [ngModel]="ticket.priority" (change)="updatePriority($event)" class="styled-select">
              <option value="LOW">Niski</option>
              <option value="NORMAL">Normalny</option>
              <option value="HIGH">ğŸ”¥ PILNE</option>
            </select>
          </div>
          <ng-template #readOnlyPriority>
            <span class="value-text">{{ ticket.priority }}</span>
          </ng-template>
        </div>

        <div class="info-group">
          <label>Kategoria</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyCategory">
             <select [ngModel]="ticket.category" (ngModelChange)="changeCategory($event)" class="styled-select">
                <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
             </select>
          </div>
          <ng-template #readOnlyCategory>
            <div class="value-text">{{ ticket.category }}</div>
          </ng-template>
        </div>
        <div class="info-group">
          <label>ZgÅ‚aszajÄ…cy</label>
          <div class="value-text user-value">ğŸ‘¤ {{ ticket.author?.username }}</div>
        </div>

        <div class="info-group">
          <label>Przypisano do</label>
          <div *ngIf="currentUserRole === 'ADMIN' || currentUserRole === 'HELPDESK'; else readOnlyAssignee">
             <select [ngModel]="ticket.assignedUser?.id" (change)="assignTicket($event)" class="styled-select">
               <option [ngValue]="null">-- Brak --</option>
               <option *ngFor="let staff of supportStaff" [value]="staff.id">
                 {{ staff.username }}
               </option>
             </select>
             <button class="action-btn-small" (click)="assignToMe()">Przypisz mnie</button>
          </div>
          <ng-template #readOnlyAssignee>
            <span class="value-text" style="color: #2980b9;">{{ ticket.assignedUser?.username || 'Brak' }}</span>
          </ng-template>
        </div>
      </div>

    </aside>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-state" style="text-align: center; padding: 50px; color: #666;">
    <h2>â³ Åadowanie zgÅ‚oszenia...</h2>
  </div>
</ng-template>